<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mini Memo App</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const API_BASE = "http://127.0.0.1:8000";

        // 공통 fetch 함수: 성공은 JSON 반환, 실패는 에러 메시지 throw
        async function apiFetch(path, options = {}) {
            const res = await fetch(`${API_BASE}${path}`, {
                headers: { "Content-Type": "application/json" },
                ...options,
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
                const msg =
                    data && (data.detail || data.error)
                        ? (data.detail || data.error)
                        : `HTTP ${res.status}`;
                throw new Error(msg);
            }

            return data;
        }

        function App() {
            const [memos, setMemos] = React.useState([]);
            const [title, setTitle] = React.useState("");
            const [content, setContent] = React.useState("");
            const [loading, setLoading] = React.useState(false);

            const [editId, setEditId] = React.useState(null); // 수정 모드: 수정할 memo_id를 저장
            const [msg, setMsg] = React.useState(""); // alert: 성공 메시지 표시
            const [error, setError] = React.useState(""); // alert: 에러 메시지 표시

            // 목록 조회: 페이지 로드 및 CRUD 후 최신 목록으로 갱신
            async function loadMemos() {
                const data = await apiFetch("/memos");
                setMemos(data);
            }

            React.useEffect(() => {
                loadMemos();
            }, []);

            // 폼 초기화: 입력값과 수정 상태를 초기 상태로 되돌림
            function resetForm() {
                setTitle("");
                setContent("");
                setEditId(null);
            }

            // 알림 초기화: 성공/에러 메시지를 비움
            function clearAlerts() {
                setMsg("");
                setError("");
            }

            // 생성/수정 통합: editId 유무로 POST 또는 PATCH 실행
            async function onSubmit() {
                clearAlerts();

                const t = title.trim();
                const c = content.trim();

                if (!t) {
                    setError("TITLE REQUIRED");
                    return;
                }

                setLoading(true);
                try {
                    const qs = new URLSearchParams({ title: t, content: c }).toString();

                    if (editId === null) {
                        await apiFetch(`/memos?${qs}`, { method: "POST" });
                        setMsg("Created");
                    } else {
                        await apiFetch(`/memos/${editId}?${qs}`, { method: "PATCH" });
                        setMsg("Updated");
                    }

                    resetForm();
                    await loadMemos();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }

            // 수정 시작: 선택한 메모 내용을 입력칸에 채우고 수정 모드로 전환
            function startEdit(m) {
                clearAlerts();
                setEditId(m.memo_id);
                setTitle(m.title);
                setContent(m.content || "");
            }

            // 삭제: 특정 memo_id를 삭제 후 목록을 다시 불러옴
            async function onDelete(id) {
                clearAlerts();

                const ok = confirm("Delete this memo?");
                if (!ok) return;

                setLoading(true);
                try {
                    await apiFetch(`/memos/${id}`, { method: "DELETE" });
                    setMsg("Deleted");
                    if (editId === id) resetForm();
                    await loadMemos();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }

            // 단건 조회(Read 1): memo_id로 상세를 조회해 alert로 보여줌
            async function onReadOne(id) {
                clearAlerts();
                try {
                    const data = await apiFetch(`/memos/${id}`);
                    setMsg(`Read: [${data.title}] ${data.content ?? ""}`);
                } catch (err) {
                    setError(err.message);
                }
            }

            return (
                <div>
                    <h1>Mini Memo App</h1>

                    <div>
                        <input
                            placeholder="title"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                        />
                    </div>

                    <div>
                        <input
                            placeholder="content"
                            value={content}
                            onChange={(e) => setContent(e.target.value)}
                        />
                    </div>

                    <div>
                        <button onClick={onSubmit} disabled={loading}>
                            {editId === null ? "추가" : "수정"}
                        </button>

                        <button
                            onClick={() => {
                                clearAlerts();
                                resetForm();
                                setMsg("Canceled");
                            }}
                            disabled={loading}
                        >
                            취소
                        </button>
                    </div>

                    <div style={{ marginTop: "8px" }}>
                        {msg && <div role="alert">{msg}</div>}
                        {error && (
                            <div role="alert" style={{ color: "red" }}>
                                {error}
                            </div>
                        )}
                    </div>

                    <hr />

                    <ul>
                        {memos.map((m) => (
                            <li key={m.memo_id}>
                                <b>[{m.title}]</b> {m.content}
                                <span style={{ marginLeft: "10px" }}>
                                    <button onClick={() => onReadOne(m.memo_id)} disabled={loading}>
                                        조회
                                    </button>
                                    <button onClick={() => startEdit(m)} disabled={loading}>
                                        수정
                                    </button>
                                    <button onClick={() => onDelete(m.memo_id)} disabled={loading}>
                                        삭제
                                    </button>
                                </span>
                            </li>
                        ))}
                    </ul>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</head>

<body>
    <div id="root"></div>
</body>

</html>